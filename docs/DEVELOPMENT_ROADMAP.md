# Workspace守り番 開発ロードマップ

## 概要

本ドキュメントは、Workspace守り番の今後の開発計画を定義します。

### 運用コンセプト

```
┌─────────────────────────────────────────────────────────┐
│  Step 1: 個別ユーザーが自分のファイルをスキャン・管理      │
│  ・自分がアクセスできるファイルのみ表示                    │
│  ・自分の権限で修正可能なものは自己是正                    │
└─────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────┐
│  Step 2: 管理者が組織全体を統合スキャン・監査              │
│  ・Domain-Wide Delegationで全ファイルを網羅               │
│  ・各ユーザーの対応状況を確認                             │
│  ・残存リスクを特定・対処                                 │
└─────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────┐
│  Step 3: ISMS/Pマーク審査用レポート出力                   │
│  ・スキャン履歴（いつ、誰が実施）                         │
│  ・是正履歴（権限変更のアクションログ）                    │
│  ・現在のリスク状況サマリー                               │
└─────────────────────────────────────────────────────────┘
```

---

## 現在の実装状況

### ✅ 完了済み

| 機能 | 説明 |
|------|------|
| Google OAuth認証 | ログイン/ログアウト、セッション管理 |
| 組織管理 | 組織作成、メンバー管理 |
| ファイルスキャン | Drive APIでファイル一覧取得、リスク評価 |
| リスク評価 | スコア計算、リスクレベル分類 |
| ファイル一覧表示 | フィルタ、ソート、ページネーション |
| ファイル詳細モーダル | 権限一覧、リスク要因表示 |
| フォルダビュー | フォルダ別ファイル集計 |
| 権限変更機能 | 権限削除、ロール変更 |
| フォルダ階層表示 | パンくずリスト形式（Google Drive風） |
| フォルダ権限表示 | 各フォルダの権限確認・変更 |
| アクションログ | 権限変更の監査ログ記録 |
| Stripe決済 | プラン管理、サブスクリプション |

### 🚧 未完了

| 機能 | 説明 |
|------|------|
| 一括操作UI | 複数ファイル選択、一括権限変更 |
| ユーザー単位スキャン分離 | スキャン結果のアクセス制御 |
| 管理者統合ビュー | 全ユーザーのスキャン結果閲覧 |
| ISMS/Pマークレポート | 監査用レポート出力 |

---

## フェーズ別開発計画

### Phase 4: スキャン結果のアクセス制御

**目的**: 各ユーザーが自分のスキャン結果のみ閲覧可能にする

#### 4-1: データモデル変更

```typescript
// 現状: スキャンは組織に紐付け
interface Scan {
  id: string;
  organizationId: string;  // 組織単位
  userId: string;          // 実行者（参考情報）
  // ...
}

// 変更後: スキャンはユーザーに紐付け
interface Scan {
  id: string;
  organizationId: string;  // 組織（課金・統計用）
  userId: string;          // 所有者（アクセス制御用）
  visibility: 'private' | 'organization';  // 公開範囲
  // ...
}
```

#### 4-2: アクセス制御ロジック

| ロール | 自分のスキャン | 他メンバーのスキャン |
|--------|---------------|-------------------|
| member | ✅ 閲覧・編集 | ❌ アクセス不可 |
| admin | ✅ 閲覧・編集 | ✅ 閲覧のみ |
| owner | ✅ 閲覧・編集 | ✅ 閲覧・編集 |

#### 4-3: API変更

- `GET /api/scan` - 自分のスキャンのみ返す（admin/ownerは全件）
- `GET /api/scan/:scanId` - 権限チェック追加
- `GET /api/scan/:scanId/files` - 権限チェック追加
- 新規: `GET /api/admin/scans` - 管理者用：全ユーザーのスキャン一覧
- 新規: `GET /api/admin/scans/user/:userId` - 特定ユーザーのスキャン

#### 4-4: UI変更

- スキャン履歴ページ: 自分のスキャンのみ表示
- 管理者用ダッシュボード: ユーザー別スキャン状況一覧
- ユーザー切り替え: 管理者が特定ユーザーのスキャン結果を閲覧

---

### Phase 5: 管理者統合ダッシュボード

**目的**: 管理者が組織全体のセキュリティ状況を俯瞰できる

#### 5-1: 組織全体サマリー

```
┌─────────────────────────────────────────────────────────┐
│  組織全体のリスク状況                                     │
│  ┌─────────┬─────────┬─────────┬─────────┐              │
│  │ Critical│  High   │ Medium  │   Low   │              │
│  │   12    │   45    │   128   │   890   │              │
│  └─────────┴─────────┴─────────┴─────────┘              │
│                                                         │
│  最終スキャン: 2025-11-30 15:30                          │
│  スキャン実施ユーザー: 8/15人                            │
└─────────────────────────────────────────────────────────┘
```

#### 5-2: ユーザー別対応状況

```
┌─────────────────────────────────────────────────────────┐
│  ユーザー      │ 最終スキャン │ リスクファイル │ 対応率  │
│  ─────────────┼─────────────┼──────────────┼────────│
│  田中太郎      │ 11/30 15:30 │ 12件         │ 80%    │
│  佐藤花子      │ 11/28 10:00 │ 5件          │ 100%   │
│  鈴木一郎      │ 未実施      │ -            │ -      │
│  ...          │             │              │        │
└─────────────────────────────────────────────────────────┘
```

#### 5-3: Domain-Wide Delegation統合スキャン

- 管理者がサービスアカウントを使用して全ユーザーのファイルをスキャン
- 個別スキャンでは見つからないリスクを検出
- 設定: Google Workspace管理コンソールでの設定ガイド提供

---

### Phase 6: ISMS/Pマーク対応レポート

**目的**: 審査・監査で提出可能な証跡レポートを出力

#### 6-1: レポート種類

| レポート | 内容 | 用途 |
|----------|------|------|
| スキャン実施履歴 | いつ、誰がスキャンを実施したか | 定期点検の証跡 |
| リスク検出レポート | 検出されたリスクの一覧と詳細 | リスクアセスメント |
| 是正対応履歴 | 権限変更のアクションログ | 是正措置の証跡 |
| 現在のリスク状況 | 残存リスクのサマリー | 現状把握 |
| 外部共有一覧 | 外部共有されているファイル一覧 | 情報資産管理 |

#### 6-2: 出力形式

- **PDF**: 審査提出用（署名・日付入り）
- **Excel**: 詳細分析用（フィルタ・ソート可能）
- **CSV**: システム連携用

#### 6-3: レポートテンプレート

```
┌─────────────────────────────────────────────────────────┐
│  【ISMS内部監査レポート】                                │
│                                                         │
│  組織名: 株式会社サンプル                                │
│  対象期間: 2025年4月1日 〜 2025年9月30日                 │
│  作成日: 2025年10月1日                                   │
│  作成者: 情報セキュリティ管理者                          │
│                                                         │
│  ■ 実施概要                                             │
│  ・定期スキャン実施回数: 12回                            │
│  ・スキャン対象ファイル総数: 15,432件                    │
│  ・リスク検出件数: 245件                                 │
│  ・是正完了件数: 238件（是正率: 97.1%）                  │
│                                                         │
│  ■ 残存リスク                                           │
│  ・Critical: 0件                                        │
│  ・High: 2件（対応中）                                  │
│  ・Medium: 5件（許容済み）                              │
│                                                         │
│  ■ 添付資料                                             │
│  ・別紙1: スキャン実施履歴                              │
│  ・別紙2: 是正対応履歴                                  │
│  ・別紙3: 残存リスク詳細                                │
└─────────────────────────────────────────────────────────┘
```

#### 6-4: API設計

```
GET /api/reports/scan-history
  ?startDate=2025-04-01
  &endDate=2025-09-30
  &format=pdf

GET /api/reports/risk-assessment
  ?scanId=xxx
  &format=excel

GET /api/reports/remediation-history
  ?startDate=2025-04-01
  &endDate=2025-09-30
  &format=pdf

GET /api/reports/current-risks
  ?minRiskLevel=high
  &format=csv

GET /api/reports/external-sharing
  ?format=excel
```

---

### Phase 7: 一括操作UI

**目的**: 複数ファイルの権限を効率的に管理

#### 7-1: ファイル選択

- チェックボックスによる複数選択
- 全選択/全解除
- フィルタ結果の一括選択

#### 7-2: 一括操作メニュー

```
┌─────────────────────────────────────┐
│  選択中: 15件                       │
│  ┌─────────────────────────────┐   │
│  │ 🗑️ 外部共有を一括削除        │   │
│  │ 🔒 閲覧のみに一括変更        │   │
│  │ 📧 所有者に一括通知          │   │
│  │ 📋 選択ファイルをエクスポート │   │
│  └─────────────────────────────┘   │
└─────────────────────────────────────┘
```

#### 7-3: 確認・実行フロー

1. ファイル選択
2. 操作選択
3. 対象確認ダイアログ（影響範囲表示）
4. 実行
5. 結果サマリー表示（成功/失敗件数）

---

### Phase 8: 通知・アラート機能

**目的**: リスクを早期発見し、関係者に通知

#### 8-1: 通知トリガー

| トリガー | 通知先 | 内容 |
|----------|--------|------|
| 新規Criticalリスク検出 | 管理者 | 即時メール通知 |
| 外部共有追加 | ファイルオーナー | 確認依頼 |
| 是正期限超過 | 担当者 + 管理者 | リマインド |
| 定期レポート | 管理者 | 週次/月次サマリー |

#### 8-2: 通知チャネル

- メール（Gmail API）
- Slack連携（Webhook）
- Google Chat連携

#### 8-3: 通知設定UI

- 通知ON/OFF
- 通知レベル設定（Critical only / High以上 / 全件）
- 通知頻度（即時 / 日次ダイジェスト / 週次）

---

## 優先順位とスケジュール

### 高優先度（次期開発）

1. **Phase 4: スキャン結果のアクセス制御**
   - セキュリティ上必須の機能
   - 現在の設計の根本的な問題を解決

2. **Phase 5: 管理者統合ダッシュボード**
   - 運用コンセプトの実現に必須

3. **Phase 6: ISMS/Pマーク対応レポート**
   - 差別化ポイント、競合未対応

### 中優先度

4. **Phase 7: 一括操作UI**
   - 運用効率向上

### 低優先度（将来）

5. **Phase 8: 通知・アラート機能**
   - 継続的な監視に有用

---

## 技術的考慮事項

### パフォーマンス

- 大量ファイル（10万件以上）への対応
- バックグラウンドジョブによるスキャン
- レポート生成の非同期化

### セキュリティ

- スキャン結果のアクセス制御（Phase 4で対応）
- 監査ログの改ざん防止
- レポートへのアクセス制御

### スケーラビリティ

- Domain-Wide Delegation対応
- 複数管理者の同時運用
- 大規模組織（1000人以上）への対応

---

## 変更履歴

| 日付 | バージョン | 変更内容 |
|------|-----------|----------|
| 2025-11-30 | 1.0 | 初版作成 |
